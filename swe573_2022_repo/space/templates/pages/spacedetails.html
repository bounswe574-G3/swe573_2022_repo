{% extends 'base.html' %}
{% load static %}
{% block title %} {{space.title}} {% endblock %}



{% block content %}

<div class="row">
  <div class="col-md-9">

    <div class="card mb-3">
        <h3 class="card-header">{{ space.title }}</h3>
        <div class="card-body">
          
          <p class="card-text">{{ space.content|safe }}</p>

          {% if request.user in space.members.all or request.user == space.author %}
          <p class="card-text"><h5><b>Creator: </b><a href="{% url 'display-members' slug=space.slug id=space.author.id %}">{{ space.author }}</a></h5></p>
          <p class="card-text"> created {{ space.created_date|timesince }} ago.
          {% endif %}
           
            <p>
              {% if request.user == space.author  %}
              <a class="btn btn-outline-primary" href="{% url 'update-space' slug=space.slug %}">Update</a>
              <a class="btn btn-outline-primary" href="{% url 'delete-space' slug=space.slug %}">Delete</a>
              {% endif %}
            </p>
          </p>      
          
        </div>
      </div>
  
  </div>
  
  <div class="col-md-3">
    <p class="card-text">
      <div class="col-md-5">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              
              <th scope="col"><h5>Space Members</h5></th>
            </tr>
          </thead>
          <tbody>
      {% if request.user in space.members.all or request.user == space.author %}
          {% for j in space.members.all %} 
            <tr>
              
              <td><a href="{% url 'display-members' slug=space.slug id=j.id %}">{{ j }}</a></td>
            </tr>
          {% endfor %}
        
          </tbody>
        </table>
      </div>
      {% endif %}       
    </p>
  
  </div>

</div>


  <div class="row">
    <div class="col-md-11">
 
      <h3> Resources</h3>

      {% if request.user in space.members.all or request.user == space.author %}
      <a class="btn btn-success btn-lg mt-3 mb-3" href="{% url 'resource' slug=space.slug %}">Add a Resource </a>

      <table class="table">
        <thead>
          <tr>
            <th scope="col">Resource</th>
            <th scope="col">Information</th>
            <th scope="col">Attachment</th>
            <th scope="col">Attacher</th>
            <th scope="col">Last Modified</th>
            <th scope="col">Update</th>
            <th scope="col">Remove</th>
          </tr>
        </thead>
        <tbody>

          {% for i in resources %}
          <tr>
            <td><a href="{% url 'display-resource' slug=space.slug id=i.id %}">{{i.resourcename|safe}}</a></td>
            <td>{{i.resourceinfo|safe|truncatechars_html:150}}</td>
            <td>{% if i.resourceattachment %}
              <a href="{{i.resourceattachment.url}}"> {{ i.resourceattachment }}</a>
              {% endif %}</td>

            <td>{{i.resourcecreator}}</td>
            <td>{{i.updated_time}}</td>
            <td><a class="btn btn-outline-success" href="{% url 'update-resource' slug=space.slug id=i.id %}">Update</a></td>
            <td><a class="btn btn-outline-success" href="{% url 'delete-resource' slug=space.slug id=i.id %}">Delete</a></td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-end">
          {% if resources.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page2=1">First Page</a>
          </li>

          <li class="page-item">
            <a class="page-link" href="?page2={{resources.previous_page_number}}" tabindex="-1" aria-disabled="true">Previous</a>
          </li>

          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">First Page</a>
          </li>

          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
          </li>
          {% endif %}
  
          <li class="page-item"><a class="page-link" href="#">{{ resources.number }}</a></li>  
  
          {% if resources.has_next %}
  
          <li class="page-item">
            <a class="page-link" href="?page2={{resources.next_page_number}}">Next</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page2={{resources.paginator.num_pages}}">Last Page</a>
          </li>
  
          {% endif %}
  
        </ul>
      </nav>

      {% elif request.user.is_authenticated %}

      <table class="table">
        <thead>
          <tr>
            <th scope="col">Resource</th>
            <th scope="col">Information</th>
            <th scope="col">Attachment</th>
            <th scope="col">Attacher</th>
            <th scope="col">Last Modified</th>
            <th scope="col">Update</th>
            <th scope="col">Remove</th>
          </tr>
        </thead>
        <tbody>

          {% for i in resources %}
          <tr>
            <td><a href="{% url 'display-resource' slug=space.slug id=i.id %}">{{i.resourcename|safe}}</a></td>
            <td>{{i.resourceinfo|safe|truncatechars_html:150}}</td>
            <td>{% if i.resourceattachment %}
              <a href="{{i.resourceattachment.url}}"> {{ i.resourceattachment }}</a>
              {% endif %}</td>

            <td>{{i.resourcecreator}}</td>
            <td>{{i.updated_time}}</td>
            <td><a>You are not authorized to update </a></td>
            <td><a>You are not authorized to delete </a></td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-end">
          {% if resources.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page2=1">First Page</a>
          </li>

          <li class="page-item">
            <a class="page-link" href="?page2={{resources.previous_page_number}}" tabindex="-1" aria-disabled="true">Previous</a>
          </li>

          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">First Page</a>
          </li>

          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
          </li>
          {% endif %}
  
          <li class="page-item"><a class="page-link" href="#">{{ resources.number }}</a></li>  
  
          {% if resources.has_next %}
  
          <li class="page-item">
            <a class="page-link" href="?page2={{resources.next_page_number}}">Next</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page2={{resources.paginator.num_pages}}">Last Page</a>
          </li>
  
          {% endif %}
  
        </ul>
      </nav>


      {% else %}

      Please login to view this part.

      {% endif %}
  
    </div>

  </div>


<div class="row">
  <div class="col-md-7">
    <h3> Discussion Baord</h3>
    {% if request.user in space.members.all or request.user == space.author %}
    <a class="btn btn-danger mt-3 mb-3" href="{% url 'create-message' slug=space.slug %}">Send a Message</a>

    {% for i in messages %}


    <div class="card">
      <div class="card-body" style="display:flex;flex-direction: row;">
        <div>
          <img src="{% static 'img/no-avatar.jpg' %}" class="rounded" class="pt-4" width="75px" height="100px">
        </div>
        <div>
          <h5 class="card-title">{{i.sender.username}}</h5>
          <p class="car-text"> {{i.message}}</p>
          <p> {{i.created_time}}</p>
        </div>
      </div>
    </div>

    {% endfor %}


    <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-end">
        {% if messages.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page1=1">First Page</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page1={{ messages.previous_page_number }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" >First Page</a>
        <li class="page-item disabled">
          <a class="page-link">Previous</a>
        </li>
        {% endif %}

        <li class="page-item"><a class="page-link" href="#">{{ messages.number }}</a></li>


        {% if messages.has_next %}

        <li class="page-item">
          <a class="page-link" href="?page1={{ messages.next_page_number }}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page1={{ messages.paginator.num_pages}}">Last Page</a>
        </li>

        {% endif %}

      </ul>
    </nav>

    {% else %}

    You are not authorized to view this part of the co-learning space.

    {% endif %}

  </div>




  <div class=" col-md-5">
    <h3> Learning Steps</h3>

    {% if request.user in space.members.all or request.user == space.author %}
    <a class="btn btn-danger mt-3 mb-3" href="{% url 'create-step' slug=space.slug %}">Add a Step</a>

    <table class="table">
      <thead>
        <tr>
          <th scope="col">Step #</th>
          <th scope="col">Title</th>
          <th scope="col">Content</th>
          <th scope="col">Related Resource</th>
          <th scope="col">Creator</th>
        </tr>
      </thead>
      <tbody>

        
        {% for i in steps %}
        <tr>
          <th scope="row">{{ forloop.counter }}</th>
          <td><a href="{% url 'display-step' slug=space.slug id=i.id %}">
            <div style="height:100%;width:100%">{{i.steptitle|safe}}</div></a></td>
          <td>{{i.stepcontent|safe|truncatechars_html:100}}</td>
          <td>{{i.relatedresource|safe}}</td>
          <td>{{i.stepcreator}}</td>
        </tr>          
        {% endfor %}

      </tbody>
    </table>

    {% elif request.user.is_authenticated %}

    <table class="table">
      <thead>
        <tr>
          <th scope="col">Step #</th>
          <th scope="col">Title</th>
          <th scope="col">Content</th>
          <th scope="col">Related Resource</th>
          <th scope="col">Creator</th>
        </tr>
      </thead>
      <tbody>

        {% for i in steps %}
        <tr>
          <th scope="row">{{ forloop.counter }}</th>
          <td><a href="{% url 'display-step' slug=space.slug id=i.id %}">
            <div style="height:100%;width:100%">{{i.steptitle|safe}}</div></a></td>
          <td>{{i.stepcontent|safe|truncatechars_html:100}}</td>
          <td>{{i.relatedresource|safe}}</td>
          <td>{{i.stepcreator}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% else %}

    Please login to view this part.

    {% endif %}


  </div>
</div>

<div class="row">
  <div class="col-md-7">
    <h3> Quizzes</h3>

    {% if request.user in space.members.all or request.user == space.author %}
    <a class="btn btn-danger mt-3 mb-3" href="{% url 'create_question' space_id=space.id %}">Create Quiz</a>

    {% for i in quizes %}

    <div class="card">
      <h3 class="card-header">Quiz {{ i.id }}</h3>
      <div class="card-body">
        <h4 class="card-title">{{ i.title }}</h4>
        <p class="card-text"><b>Creator:</b> {{ i.creator }}</p>
        <a href="/quiz/attempt-quiz/{{i.id}}/" class="btn btn-primary">Attempt Quiz</a>
      </div>
    </div>

    {% empty %}

    <p>There isn't any quizes.</p>

    {% endfor %}

    {% elif request.user.is_authenticated %}
    <p>else part</p>

    {% else %}

    Please login to view this part.

    {% endif %}

  </div>




  <div class=" col-md-5">
    <h3> Glossary</h3>

    {% if request.user in space.members.all or request.user == space.author %}
    <a class="btn btn-danger mt-3 mb-3" href="{% url 'create-term' slug=space.slug %}">Write a Term</a>

    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Term #</th>
          <th scope="col">Term</th>
          <th scope="col">Definition</th>
          <th scope="col">Related Step</th>
          <th scope="col">Writer</th>
        </tr>
      </thead>
      <tbody>

        {% for i in terms %}
        <tr>
          <th scope="row">{{ forloop.counter }}</th>
          <td>{{i.termtitle|safe}}</td>
          <td>{{i.termdefinition|safe}}</td>
          <td>{{i.termstep|safe}}</td>
          <td>{{i.termwriter}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% elif request.user.is_authenticated %}

    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Term #</th>
          <th scope="col">Term</th>
          <th scope="col">Definition</th>
          <th scope="col">Related Step</th>
          <th scope="col">Writer</th>
        </tr>
      </thead>
      <tbody>

        {% for i in terms %}
        <tr>
          <th scope="row">{{ forloop.counter }}</th>
          <td>{{i.termtitle|safe}}</td>
          <td>{{i.termdefinition|safe}}</td>
          <td>{{i.termstep|safe}}</td>
          <td>{{i.termwriter}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% else %}

    Please login to view this part.

    {% endif %}


  </div>
</div>

<div class="row">
  <div class="col-md-11">
    <h3> Relationship Graph</h3>
    {% if request.user in space.members.all or request.user == space.author %}
    <a class="btn btn-primary" style="float:right" href="{% url 'create-content' slug=space.slug %}">Add</a>
    <a class="btn btn-warning" style="float: right; margin-right: 30px" href="{% url 'display-contents' slug=space.slug %}">Edit</a>
    {% endif %}
    <div id="canvas" data-id="{{space.slug}}"></div>
  </div>
  
</div>

<style>
  rect {
    cursor: pointer !important;
  }
  tspan{
    cursor:  pointer !important;
  }
  </style>
<script>
  $(document).ready(function() {
  
  
    var g = new Dracula.Graph();
    var width = 1200;
    var height = 450;

      //var width = $(document).width()+70;
    //var height = $(document).height()+10;
  
  var render = function (r, n) {
        var frame = r.rect(0 - 3*n.label.length,  -10, 6*n.label.length, 50);
        frame.attr({
            fill: n.Color, r: 9,
            'stroke-width': 2
        });
        /* the Raphael set is obligatory, containing all you want to display */
        var set = r.set().push(frame.attr({ fill: '#fcfcfc','fill-opacity': 1, 'stroke-width': 2, r: 9 }))
            .push(r.text(0,  10,n.label)).click(function () {
              if(n.link !=null)
              {
                window.location.href = n.link;

              }
  });
        return set;
    };
  
    var slug = $('#canvas').data("id");
    $.ajax({
      type: 'GET',
          async: false,
      url: '/spacedetails/'+slug +'/content',
      data: {},
      dataType: 'json',
      success: function (response) {
              for ( var i = 0; i < response.nodes.length; i++ ) {
                  g.addNode(response.nodes[i].id, {
                      label: response.nodes[i].title ,
                      link: response.nodes[i].link,
                      /* filling the shape with a color makes it easier to be dragged */
                      render: render
                      });
              }
              for ( var i = 0; i < response.relations.length; i++ ) {
                  g.addEdge(response.relations[i].source_content_id, response.relations[i].target_content_id, { directed : true });
              }
      },
      error: function (response) {
        alert(response["responseJSON"]["error"]);
      }
    })
  
  
  
  var layouter = new Dracula.Layout.Spring(g);
    
  
    var renderer = new Dracula.Renderer.Raphael(document.getElementById('canvas'), g, width-100, height-50);
    layouter.layout();
    renderer.draw();
    });
  </script>
{% endblock %}